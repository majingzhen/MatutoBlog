{{define "admin_content"}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">文章管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/admin/articles/create" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-plus"></i> 新建文章
            </a>
        </div>
    </div>
</div>

<!-- 筛选和搜索 -->
<div class="row mb-3">
    <div class="col-md-6">
        <form method="GET" action="/admin/articles" class="d-flex">
            <input type="text" name="keyword" class="form-control me-2" placeholder="搜索文章标题..." value="{{.keyword}}">
            <button class="btn btn-outline-secondary" type="submit">搜索</button>
        </form>
    </div>
    <div class="col-md-6">
        <div class="d-flex justify-content-end">
            <select class="form-select" style="width: auto;" onchange="filterByStatus(this.value)">
                <option value="">全部状态</option>
                <option value="1" {{if eq .current_status "1"}}selected{{end}}>已发布</option>
                <option value="0" {{if eq .current_status "0"}}selected{{end}}>草稿</option>
            </select>
        </div>
    </div>
</div>

<!-- 文章列表 -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>标题</th>
                <th>分类</th>
                <th>状态</th>
                <th>阅读量</th>
                <th>评论数</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {{if .articles}}
                {{range .articles}}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {{if .IsTop}}
                            <span class="badge bg-danger me-2">置顶</span>
                            {{end}}
                            <a href="/article/{{.ID}}" target="_blank" class="text-decoration-none">{{.Title}}</a>
                        </div>
                    </td>
                    <td>{{if .Category}}{{.Category.Name}}{{else}}-{{end}}</td>
                    <td>
                        {{if eq .Status 1}}
                        <span class="badge bg-success">已发布</span>
                        {{else}}
                        <span class="badge bg-secondary">草稿</span>
                        {{end}}
                    </td>
                    <td>{{.ViewCount}}</td>
                    <td>{{.CommentCount}}</td>
                    <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="/admin/articles/{{.ID}}/edit" class="btn btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteArticle({{.ID}})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{end}}
            {{else}}
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    暂无文章数据
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<!-- 分页 -->
{{if .pagination}}
{{if gt .pagination.pages 1}}
<nav aria-label="文章分页" class="mt-4">
    <ul class="pagination justify-content-center">
        {{if gt .pagination.page 1}}
        <li class="page-item">
            <a class="page-link" href="?page={{sub .pagination.page 1}}{{if .keyword}}&keyword={{.keyword}}{{end}}{{if .current_status}}&status={{.current_status}}{{end}}">上一页</a>
        </li>
        {{end}}
        
        {{$current := .pagination.page}}
        {{$total := .pagination.pages}}
        {{$start := 1}}
        {{$end := $total}}
        
        {{if gt $total 10}}
            {{if gt $current 5}}
                {{$start = sub $current 4}}
            {{end}}
            {{if lt (add $current 4) $total}}
                {{$end = add $current 4}}
            {{else}}
                {{$end = $total}}
                {{if gt $total 10}}
                    {{$start = sub $total 9}}
                {{end}}
            {{end}}
        {{end}}
        
        {{range $i := $start}}
            {{if le $i $end}}
                {{if eq $i $current}}
                <li class="page-item active">
                    <span class="page-link">{{$i}}</span>
                </li>
                {{else}}
                <li class="page-item">
                    <a class="page-link" href="?page={{$i}}{{if $.keyword}}&keyword={{$.keyword}}{{end}}{{if $.current_status}}&status={{$.current_status}}{{end}}">{{$i}}</a>
                </li>
                {{end}}
            {{end}}
        {{end}}

        {{if lt .pagination.page .pagination.pages}}
        <li class="page-item">
            <a class="page-link" href="?page={{add .pagination.page 1}}{{if .keyword}}&keyword={{.keyword}}{{end}}{{if .current_status}}&status={{.current_status}}{{end}}">下一页</a>
        </li>
        {{end}}
    </ul>
</nav>
{{end}}
{{end}}

<script>
function filterByStatus(status) {
    const url = new URL(window.location);
    if (status) {
        url.searchParams.set('status', status);
    } else {
        url.searchParams.delete('status');
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

function deleteArticle(id) {
    if (confirm('确定要删除这篇文章吗？删除后无法恢复。')) {
        fetch(`/admin/articles/${id}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                alert('文章删除成功');
                location.reload();
            } else {
                alert(data.msg || '删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('网络错误，请稍后再试');
        });
    }
}
</script>
{{end}}